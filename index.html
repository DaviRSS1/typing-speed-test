<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="./assets/images/favicon-32x32.png"
    />
    <title>Typing Speed Test</title>
    <link rel="stylesheet" type="text/css" href="style.css" media="screen" />
  </head>
  <body>
    <main class="page">
      <header class="top">
        <img
          src="assets/images/logo-large.svg"
          alt="Typing Speed Test Logo"
          class="logo-desktop"
        />
        <img
          src="assets/images/logo-small.svg"
          alt="Typing Speed Test Logo"
          class="logo-mobile"
        />
        <div>
          <img src="assets/images/icon-personal-best.svg" alt="Personal Best" />
          <p class="best-desktop">
            Personal best: <span class="bestWpm">0</span> WPM
          </p>
          <p class="best-mobile">Best: <span class="bestWpm">0</span> WPM</p>
        </div>
      </header>
      <section class="game-screen">
        <section class="menu">
          <div class="stats">
            <div class="stat">
              <span class="label">WPM:</span>
              <span class="value" id="wpm">0</span>
            </div>
            <div class="stat">
              <span class="label">Accuracy:</span>
              <span class="value" id="acc">100%</span>
            </div>
            <div class="stat">
              <span class="label">Time:</span>
              <span class="value" id="time">60s</span>
            </div>
          </div>

          <div class="options">
            <div class="desktop-options">
              <div>
                <p>Difficulty:</p>
                <label>
                  <input type="radio" name="difficulty" value="easy" checked />
                  Easy </label
                ><label>
                  <input type="radio" name="difficulty" value="medium" />
                  Medium </label
                ><label>
                  <input type="radio" name="difficulty" value="hard" />
                  Hard
                </label>
              </div>
              <div>
                <p>Mode:</p>
                <label>
                  <input type="radio" name="mode" value="timed" checked />
                  Timed (60s) </label
                ><label>
                  <input type="radio" name="mode" value="passage" />
                  Passage
                </label>
              </div>
            </div>
            <div class="mobile-options">
              <div class="dropdown" data-type="difficulty">
                <button class="dropdown-btn">
                  Easy
                  <span class="arrow"
                    ><img src="assets/images/icon-down-arrow.svg"
                  /></span>
                </button>
                <div class="dropdown-menu">
                  <label
                    ><input type="radio" name="difficulty" value="easy" />
                    Easy</label
                  >
                  <label
                    ><input type="radio" name="difficulty" value="medium" />
                    Medium</label
                  >
                  <label
                    ><input type="radio" name="difficulty" value="hard" />
                    Hard</label
                  >
                </div>
              </div>

              <div class="dropdown" data-type="mode">
                <button class="dropdown-btn">
                  Timed (60s)
                  <span class="arrow"
                    ><img src="assets/images/icon-down-arrow.svg"
                  /></span>
                </button>
                <div class="dropdown-menu">
                  <label
                    ><input type="radio" name="mode" value="timed" /> Timed
                    (60s)</label
                  >
                  <label
                    ><input type="radio" name="mode" value="passage" />
                    Passage</label
                  >
                </div>
              </div>
            </div>
          </div>
        </section>
        <div class="divisor"></div>
        <section class="text-area locked">
          <p id="text"></p>
          <button id="start">Start Typing Test</button>
          <div class="reset">
            <div class="divisor"></div>
            <button id="restart">
              Restart Test
              <img src="assets/images/icon-restart.svg" alt="restart" />
            </button>
          </div>
        </section>
      </section>
      <section class="finished-page">
        <img
          class="bg-star left"
          src="assets/images/pattern-star-1.svg"
          alt=""
        />
        <img
          class="bg-star right"
          src="assets/images/pattern-star-2.svg"
          alt=""
        />
        <img class="confetti" src="assets/images/pattern-confetti.svg" alt="" />

        <div class="complete-icon">
          <span></span>
          <span></span>
          <img src="assets/images/icon-completed.svg" />
        </div>
        <h2 id="result-title"></h2>
        <p id="result-subtitle"></p>
        <div class="stats-complete">
          <p class="wpm">
            WPM
            <span id="wpm-complete"></span>
          </p>
          <p class="acc">
            Accuracy
            <span id="acc-complete"></span>
          </p>
          <p class="chars-typed">
            Characters
            <span id="chars-complete">
              <span id="chars-correct"></span> /
              <span id="chars-wrong"></span>
            </span>
          </p>
        </div>
        <button id="result-action">
          <span id="result-action-text"></span>
          <img src="assets/images/icon-restart.svg" alt="restart" />
        </button>
      </section>
    </main>
    <footer class="attribution">
      Coded by <a href="https://github.com/DaviRSS1">Davi Reghim</a>.
    </footer>
  </body>
</html>

<script>
  const DOM = {
    text: document.getElementById("text"),
    wpm: document.getElementById("wpm"),
    acc: document.getElementById("acc"),
    time: document.getElementById("time"),
    startBtn: document.getElementById("start"),
    restartBtn: document.getElementById("restart"),
    textArea: document.querySelector(".text-area"),
    resetDiv: document.querySelector(".reset"),
    gameScreen: document.querySelector(".game-screen"),
    finishScreen: document.querySelector(".finished-page"),
    bestWpmEls: document.querySelectorAll(".bestWpm"),
    resultTitle: document.getElementById("result-title"),
    resultSubtitle: document.getElementById("result-subtitle"),
    resultActionText: document.getElementById("result-action-text"),
    resultActionBtn: document.getElementById("result-action"),
    dropdowns: document.querySelectorAll(".dropdown-btn"),
    dropdownInputs: document.querySelectorAll(".dropdown-menu input"),
  };

  const RESULT_TYPE = {
    BASELINE: "baseline",
    NORMAL: "normal",
    HIGHSCORE: "highscore",
  };
  const INITIAL_TIME = 60;

  let gameState = {
    dataJSON: null,
    chars: [],
    currentIndex: 0,
    correct: 0,
    totalTyped: 0,
    time: INITIAL_TIME,
    elapsedTime: 0,
    timer: null,
    started: false,
    mode: "timed",
    bestWpm: Number(localStorage.getItem("bestWpm")) || 0,
  };

  DOM.bestWpmEls.forEach((el) => (el.textContent = gameState.bestWpm));

  fetch("data.json")
    .then((res) => res.json())
    .then((data) => {
      gameState.dataJSON = data;
      loadText("hard", 1);
    })
    .catch(console.error);

  function getOption(name) {
    return document.querySelector(`input[name="${name}"]:checked`).value;
  }

  function getRandomId() {
    return Math.floor(Math.random() * 10) + 1;
  }

  function loadText(difficulty, id) {
    const item = gameState.dataJSON[difficulty].find(
      (t) => t.id === `${difficulty}-${id}`,
    );
    DOM.text.innerHTML = item.text
      .split("")
      .map((char) => `<span>${char}</span>`)
      .join("");
    gameState.chars = DOM.text.querySelectorAll("span");
    gameState.currentIndex = 0;
    if (gameState.chars.length > 0) gameState.chars[0].classList.add("current");
  }

  function startGame(isRestart = false) {
    resetTimerUI();
    closeAllDropdowns();

    if (isRestart) {
      clearInterval(gameState.timer);
      DOM.restartBtn.blur();
      resetStats();
    } else {
      DOM.textArea.classList.remove("locked");
      DOM.startBtn.style.display = "none";
      DOM.resetDiv.style.display = "block";
    }

    const difficulty = getOption("difficulty");
    gameState.mode = getOption("mode");
    loadText(difficulty, getRandomId());

    gameState.started = true;
    manageTimer();
  }

  function manageTimer() {
    if (gameState.mode === "timed") {
      gameState.time = INITIAL_TIME;
      DOM.time.textContent = gameState.time;

      gameState.timer = setInterval(() => {
        gameState.time--;
        DOM.time.textContent = gameState.time;

        if (gameState.time <= 40) DOM.time.style.color = "hsl(49, 85%, 70%)";
        if (gameState.time <= 20) DOM.time.style.color = "hsl(354, 63%, 57%)";

        if (gameState.time <= 0) {
          finishTest();
        }
      }, 1000);
    } else {
      gameState.elapsedTime = 0;
      DOM.time.textContent = "0";

      gameState.timer = setInterval(() => {
        gameState.elapsedTime++;
        DOM.time.textContent = gameState.elapsedTime;
      }, 1000);
    }
  }

  function handleTyping(e) {
    if (!gameState.started) return;

    const typed = e.key;
    if (typed.length > 1) return;

    const expected = gameState.chars[gameState.currentIndex].textContent;
    gameState.totalTyped++;

    const charEl = gameState.chars[gameState.currentIndex];
    if (typed === expected) {
      charEl.classList.add("correct");
      gameState.correct++;
    } else {
      charEl.classList.add("incorrect");
    }

    charEl.classList.remove("current");
    gameState.currentIndex++;

    if (gameState.chars[gameState.currentIndex]) {
      gameState.chars[gameState.currentIndex].classList.add("current");
    } else {
      finishTest();
    }

    updateStatsDisplay();
  }

  function updateStatsDisplay() {
    const accuracy =
      gameState.totalTyped > 0
        ? (gameState.correct / gameState.totalTyped) * 100
        : 100;
    DOM.acc.textContent = accuracy.toFixed(1) + "%";

    let minutes =
      gameState.mode === "timed"
        ? (INITIAL_TIME - gameState.time) / 60
        : gameState.elapsedTime / 60;

    const wpm = minutes > 0 ? gameState.correct / 5 / minutes : 0;
    DOM.wpm.textContent = Math.floor(wpm);
  }

  function finishTest() {
    clearInterval(gameState.timer);
    gameState.started = false;
    document.removeEventListener("keydown", handleTyping);

    const currentWpm = Number(DOM.wpm.textContent);
    const accuracy =
      gameState.totalTyped > 0
        ? ((gameState.correct / gameState.totalTyped) * 100).toFixed(1)
        : "100.0";

    document.getElementById("wpm-complete").textContent = currentWpm;

    const accEl = document.getElementById("acc-complete");
    accEl.textContent = accuracy + "%";
    accEl.className = "";
    accEl.classList.add(
      accuracy >= 90 ? "acc-good" : accuracy >= 70 ? "acc-mid" : "acc-bad",
    );

    document.getElementById("chars-correct").textContent = gameState.correct;
    document.getElementById("chars-wrong").textContent =
      gameState.totalTyped - gameState.correct;

    let resultType = RESULT_TYPE.NORMAL;
    if (!localStorage.getItem("hasBaseline")) {
      resultType = RESULT_TYPE.BASELINE;
      localStorage.setItem("hasBaseline", "true");
    } else if (currentWpm > gameState.bestWpm) {
      resultType = RESULT_TYPE.HIGHSCORE;
      gameState.bestWpm = currentWpm;
      localStorage.setItem("bestWpm", gameState.bestWpm);
      DOM.bestWpmEls.forEach((el) => (el.textContent = gameState.bestWpm));
    }

    renderResultScreen(resultType);
  }

  function renderResultScreen(type) {
    const config = {
      [RESULT_TYPE.BASELINE]: {
        title: "Baseline Established!",
        sub: "You've set the bar. Now the real challenge begins - time to beat it.",
        action: "Beat This Score",
      },
      [RESULT_TYPE.NORMAL]: {
        title: "Test Complete!",
        sub: "Solid run. Keep pushing to beat your high score.",
        action: "Go Again",
      },
      [RESULT_TYPE.HIGHSCORE]: {
        title: "High Score Smashed!",
        sub: "You're getting faster. That was incredible typing.",
        action: "Beat This Score",
      },
    };

    DOM.resultTitle.textContent = config[type].title;
    DOM.resultSubtitle.textContent = config[type].sub;
    DOM.resultActionText.textContent = config[type].action;

    const stars = document.querySelectorAll(".bg-star");
    const confetti = document.querySelector(".confetti");

    stars.forEach(
      (s) =>
        (s.style.display = type !== RESULT_TYPE.HIGHSCORE ? "block" : "none"),
    );
    if (confetti)
      confetti.style.display =
        type === RESULT_TYPE.HIGHSCORE ? "block" : "none";

    DOM.gameScreen.style.display = "none";
    DOM.finishScreen.style.display = "flex";
  }

  function resetStats() {
    gameState.correct = 0;
    gameState.totalTyped = 0;
    gameState.time = INITIAL_TIME;
    gameState.elapsedTime = 0;
    DOM.wpm.textContent = "0";
    DOM.acc.textContent = "100%";
    DOM.time.textContent = INITIAL_TIME;
    document.addEventListener("keydown", handleTyping);
  }

  function resetTimerUI() {
    DOM.time.style.color = "#fff";
  }

  function closeAllDropdowns() {
    document
      .querySelectorAll(".dropdown-menu.open")
      .forEach((menu) => menu.classList.remove("open"));
  }

  DOM.startBtn.addEventListener("click", () => startGame(false));
  DOM.restartBtn.addEventListener("click", () => startGame(true));

  DOM.resultActionBtn.addEventListener("click", () => {
    DOM.finishScreen.style.display = "none";
    DOM.gameScreen.style.display = "block";
    resetStats();
    resetTimerUI();

    gameState.mode = getOption("mode");
    loadText(getOption("difficulty"), getRandomId());

    DOM.textArea.classList.add("locked");
    DOM.startBtn.style.display = "block";
    DOM.resetDiv.style.display = "none";
    DOM.startBtn.focus();
  });

  document.addEventListener("keydown", handleTyping);

  DOM.dropdowns.forEach((btn) => {
    btn.addEventListener("click", () =>
      btn.nextElementSibling.classList.toggle("open"),
    );
  });

  DOM.dropdownInputs.forEach((input) => {
    input.addEventListener("change", () => {
      const btn = input.closest(".dropdown").querySelector(".dropdown-btn");
      btn.childNodes[0].textContent = input.parentElement.textContent.trim();
    });
  });
</script>
