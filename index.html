<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- displays site properly based on user's device -->

    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="./assets/images/favicon-32x32.png"
    />

    <title>Typing Speed Test</title>
    <link rel="stylesheet" type="text/css" href="style.css" media="screen" />
  </head>
  <body>
    <main class="page">
      <header class="top">
        <img src="assets/images/logo-large.svg" alt="Typing Speed Test Logo" />
        <div>
          <img src="assets/images/icon-personal-best.svg" alt="Personal Best" />
          <p>Personal best: <span id="bestWpm">0</span> WPM</p>
        </div>
      </header>
      <section class="game-screen">
        <section class="menu">
          <div class="stats">
            <p class="wpm">WPM: <span id="wpm"></span></p>
            <p class="acc">Accuracy: <span id="acc">%</span></p>
            <p class="time">Time: <span id="time"></span></p>
          </div>
          <div class="options">
            <div>
              <p>Difficulty:</p>
              <label>
                <input type="radio" name="difficulty" value="easy" checked />
                Easy </label
              ><label>
                <input type="radio" name="difficulty" value="medium" />
                Medium </label
              ><label>
                <input type="radio" name="difficulty" value="hard" />
                Hard
              </label>
            </div>
            <div>
              <p>Mode:</p>
              <label>
                <input type="radio" name="mode" value="timed" checked />
                Timed (60s) </label
              ><label>
                <input type="radio" name="mode" value="passage" />
                Passage
              </label>
            </div>
          </div>
        </section>
        <div class="divisor"></div>
        <section class="text-area locked">
          <p id="text"></p>
          <button id="start">Start Typing Test</button>
          <div class="reset">
            <div class="divisor"></div>
            <button id="restart">
              Restart Test
              <img src="assets/images/icon-restart.svg" alt="restart" />
            </button>
          </div>
        </section>
      </section>
      <section class="finished-page">
        <img
          class="bg-star left"
          src="assets/images/pattern-star-1.svg"
          alt=""
        />
        <img
          class="bg-star right"
          src="assets/images/pattern-star-2.svg"
          alt=""
        />
        <img class="confetti" src="assets/images/pattern-confetti.svg" alt="" />

        <div class="complete-icon">
          <span></span>
          <span></span>
          <img src="assets/images/icon-completed.svg" />
        </div>
        <h2 id="result-title"></h2>
        <p id="result-subtitle"></p>
        <div class="stats-complete">
          <p class="wpm">
            WPM
            <span id="wpm-complete"></span>
          </p>
          <p class="acc">
            Accuracy
            <span id="acc-complete"></span>
          </p>
          <p class="chars-typed">
            Characters
            <span id="chars-complete">
              <span id="chars-correct"></span> /
              <span id="chars-wrong"></span>
            </span>
          </p>
        </div>
        <button id="result-action">
          <span id="result-action-text"></span>
          <img src="assets/images/icon-restart.svg" alt="restart" />
        </button>
      </section>
    </main>
    <footer class="attribution">
      Coded by <a href="https://github.com/DaviRSS1">Davi Reghim</a>.
    </footer>
  </body>
</html>

<script>
  const RESULT_TYPE = {
    BASELINE: "baseline",
    NORMAL: "normal",
    HIGHSCORE: "highscore",
  };

  const bestWpmEl = document.getElementById("bestWpm");

  let bestWpm = localStorage.getItem("bestWpm") || 0;
  bestWpmEl.textContent = bestWpm;

  const textElement = document.getElementById("text");
  const wpmEl = document.getElementById("wpm");
  const accEl = document.getElementById("acc");
  const timeEl = document.getElementById("time");
  const startBtn = document.getElementById("start");
  const textArea = document.querySelector(".text-area");
  const restartBtn = document.getElementById("restart");
  const resetDiv = document.querySelector(".reset");

  let dataJSON;

  let chars = [];
  let currentIndex = 0;
  let correct = 0;
  let totalTyped = 0;
  let time = 60;
  let timer;
  let started = false;
  let mode = "timed";
  let elapsedTime = 0;

  fetch("data.json")
    .then((res) => res.json())
    .then((data) => {
      dataJSON = data;

      loadText("hard", 1);
    })
    .catch((err) => console.error(err));

  startBtn.addEventListener("click", () => {
    resetTimerUI();
    textArea.classList.remove("locked");
    startBtn.style.display = "none";
    resetDiv.style.display = "block";

    const difficulty = getSelectedDifficulty();
    const randomId = getRandomId();
    mode = getSelectedMode();

    loadText(difficulty, randomId);

    started = true;

    if (mode === "timed") {
      time = 60;
      startTimer(); // countdown
    } else {
      elapsedTime = 0;
      startCountUpTimer(); // count up
    }
  });

  restartBtn.addEventListener("click", () => {
    resetTimerUI();
    clearInterval(timer);
    resetStats();
    restartBtn.blur();

    const difficulty = getSelectedDifficulty();
    const randomId = getRandomId();
    mode = getSelectedMode();

    loadText(difficulty, randomId);

    started = true;

    if (mode === "timed") {
      time = 60;
      startTimer();
    } else {
      elapsedTime = 0;
      startCountUpTimer();
    }
  });

  function getRandomId() {
    return Math.floor(Math.random() * 10) + 1;
  }

  function getSelectedDifficulty() {
    return document.querySelector('input[name="difficulty"]:checked').value;
  }

  function getSelectedMode() {
    return document.querySelector('input[name="mode"]:checked').value;
  }

  function loadText(difficulty, id) {
    const item = dataJSON[difficulty].find(
      (t) => t.id === `${difficulty}-${id}`,
    );

    textElement.innerHTML = item.text
      .split("")
      .map((char) => `<span>${char}</span>`)
      .join("");

    chars = textElement.querySelectorAll("span");
    currentIndex = 0;

    if (chars.length > 0) {
      chars[0].classList.add("current");
    }
  }

  function startTimer() {
    timeEl.textContent = time;

    timer = setInterval(() => {
      time--;
      timeEl.textContent = time;

      if (time <= 40) timeEl.style.color = "hsl(49, 85%, 70%)";
      if (time <= 20) timeEl.style.color = "hsl(354, 63%, 57%)";

      if (time <= 0) {
        clearInterval(timer);
        document.removeEventListener("keydown", handleTyping);
      }
    }, 1000);

    if (time <= 0 && mode === "timed") {
      clearInterval(timer);
      finishTest();
    }
  }

  function startCountUpTimer() {
    timeEl.textContent = "0";

    timer = setInterval(() => {
      elapsedTime++;
      timeEl.textContent = elapsedTime;
    }, 1000);
  }

  function handleTyping(e) {
    if (!started) return;

    const expected = chars[currentIndex].textContent;
    const typed = e.key;

    if (typed.length > 1) return;

    totalTyped++;

    if (typed === expected) {
      chars[currentIndex].classList.add("correct");
      correct++;
    } else {
      chars[currentIndex].classList.add("incorrect");
    }

    chars[currentIndex].classList.remove("current");
    currentIndex++;

    if (chars[currentIndex]) {
      chars[currentIndex].classList.add("current");
    }

    updateStats();

    if (currentIndex >= chars.length) {
      finishTest();
    }
  }

  function finishTest() {
    clearInterval(timer);
    started = false;

    const previousBest = Number(bestWpm);
    const currentWpm = Number(wpmEl.textContent);

    const accuracy =
      totalTyped > 0 ? ((correct / totalTyped) * 100).toFixed(1) : "100.0";

    const incorrect = totalTyped - correct;

    // ===== RESULT STATS =====
    document.getElementById("wpm-complete").textContent = currentWpm;

    const accCompleteEl = document.getElementById("acc-complete");
    accCompleteEl.textContent = accuracy + "%";
    accCompleteEl.className = "";

    if (accuracy >= 90) accCompleteEl.classList.add("acc-good");
    else if (accuracy >= 70) accCompleteEl.classList.add("acc-mid");
    else accCompleteEl.classList.add("acc-bad");

    const correctEl = document.getElementById("chars-correct");
    const wrongEl = document.getElementById("chars-wrong");

    correctEl.textContent = correct;
    wrongEl.textContent = incorrect;

    correctEl.className = "chars-correct";
    wrongEl.className = "chars-wrong";

    let resultType = RESULT_TYPE.NORMAL;

    if (!localStorage.getItem("hasBaseline")) {
      resultType = RESULT_TYPE.BASELINE;
      localStorage.setItem("hasBaseline", "true");
    } else if (currentWpm > previousBest) {
      resultType = RESULT_TYPE.HIGHSCORE;
    }

    if (currentWpm > previousBest) {
      bestWpm = currentWpm;
      localStorage.setItem("bestWpm", bestWpm);
      bestWpmEl.textContent = bestWpm;
    }

    renderResult(resultType);
    showResultScreen();
  }

  function showResultScreen() {
    document.querySelector(".game-screen").style.display = "none";
    document.querySelector(".finished-page").style.display = "flex";
  }

  function updateStats() {
    const accuracy = totalTyped > 0 ? (correct / totalTyped) * 100 : 100;
    accEl.textContent = accuracy.toFixed(1) + "%";

    let minutes;

    if (mode === "timed") {
      minutes = (60 - time) / 60;
    } else {
      minutes = elapsedTime / 60;
    }

    const wpm = minutes > 0 ? correct / 5 / minutes : 0;
    wpmEl.textContent = Math.floor(wpm);
  }

  function resetTimerUI() {
    timeEl.style.color = "#fff";
  }

  function resetStats() {
    correct = 0;
    totalTyped = 0;
    time = 60;

    wpmEl.textContent = "0";
    accEl.textContent = "100%";
    timeEl.textContent = time;
    resetTimerUI();
  }

  document.addEventListener("keydown", handleTyping);

  function renderResult(type) {
    const titleEl = document.getElementById("result-title");
    const subtitleEl = document.getElementById("result-subtitle");
    const actionTextEl = document.getElementById("result-action-text");

    const stars = document.querySelectorAll(".bg-star");
    const confetti = document.querySelector(".confetti");

    // reset visual
    stars.forEach((s) => (s.style.display = "none"));
    if (confetti) confetti.style.display = "none";

    if (type === "baseline") {
      titleEl.textContent = "Baseline Established!";
      subtitleEl.textContent =
        "You've set the bar. Now the real challenge begins - time to beat it.";
      actionTextEl.textContent = "Beat This Score";

      stars.forEach((s) => (s.style.display = "block"));
    }

    if (type === "normal") {
      titleEl.textContent = "Test Complete!";
      subtitleEl.textContent =
        "Solid run. Keep pushing to beat your high score.";
      actionTextEl.textContent = "Go Again";

      stars.forEach((s) => (s.style.display = "block"));
    }

    if (type === "highscore") {
      titleEl.textContent = "High Score Smashed!";
      subtitleEl.textContent =
        "You're getting faster. That was incredible typing.";
      actionTextEl.textContent = "Beat This Score";

      if (confetti) confetti.style.display = "block";
    }
  }

  const resultActionBtn = document.getElementById("result-action");

  resultActionBtn.addEventListener("click", () => {
    document.querySelector(".finished-page").style.display = "none";
    document.querySelector(".game-screen").style.display = "block";

    resetStats();

    const difficulty = getSelectedDifficulty();
    const randomId = getRandomId();
    mode = getSelectedMode();

    loadText(difficulty, randomId);

    textArea.classList.add("locked");
    startBtn.style.display = "block";
    resetDiv.style.display = "none";

    startBtn.focus();
  });
</script>
